@model TaMinhPhuoc_BaiTongHop.Models.User

@{
    ViewData["Title"] = "Create";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="container mt-5" ng-app="registrationApp" ng-controller="registrationController">
    <div class="row">
        <div class="col-md-6 m-auto">
            <div class="mb-3">
                <h2>Đăng Ký Người Dùng</h2>
            </div>
            <form name="registrationForm" novalidate>
                <div class="mb-3 position-relative">
                    <label>Họ và tên:</label>
                    <input type="text" name="fullName" placeholder="Nhập họ và tên" ng-model="user.fullName" required ng-keyup="validateField('fullName')" class="form-control" id="fullName" ng-class="{'border border-danger': tooltips.fullName, 'border border-success': !tooltips.fullName && registrationForm.fullName.$dirty}" />
                    <div class="d-inline-block tooltip-block">
                        <i class="fa-solid fa-circle-exclamation" ng-mouseenter="hover.fullname = true" ng-mouseleave="hover.fullname = false"></i>
                        <span class="custom-tooltip" ng-class="{'tooltip-hidden': !tooltips.fullName && !hover.fullname}" id="fullNameTooltip">Họ tên là bắt buộc</span>
                    </div>
                </div>
                <div class="mb-3 position-relative">
                    <label>Số Điện Thoại:</label>
                    <input type="text" name="phoneNumber" placeholder="Nhập số điện thoại" ng-model="user.phoneNumber" required ng-keyup="validateField('phoneNumber')" ng-pattern="/^(09|03|07|08|01)\d{8}$/" class="form-control" id="phoneNumber" ng-class="{'border border-danger': tooltips.phoneNumber, 'border border-success': !tooltips.phoneNumber && registrationForm.phoneNumber.$dirty}" />
                    <div class="d-inline-block tooltip-block" style="left:97px;">
                        <i class="fa-solid fa-circle-exclamation" ng-mouseenter="hover.phoneNumber = true" ng-mouseleave="hover.phoneNumber = false"></i>
                        <span class="custom-tooltip" ng-class="{'tooltip-hidden': !tooltips.phoneNumber && !hover.phoneNumber}" id="phoneNumberTooltip">Số điện thoại là bắt buộc gồm 10 số và bắt đầu với các số (09|03|07|08|01)</span>
                    </div>
                </div>
                <div class="mb-3 position-relative">
                    <label>Ngày Sinh:</label>
                    <input type="date" name="birthDate" placeholder="Nhập ngày sinh" ng-model="user.birthDate" required ng-change="validateField('birthDate')" class="form-control" id="birthDate" ng-class="{'border border-danger': tooltips.birthDate, 'border border-success': !tooltips.birthDate && registrationForm.birthDate.$dirty}" />
                    <div class="d-inline-block tooltip-block" style="left:72px;">
                        <i class="fa-solid fa-circle-exclamation" ng-mouseenter="hover.birthDate = true" ng-mouseleave="hover.birthDate = false"></i>
                        <span class="custom-tooltip" ng-class="{'tooltip-hidden': !tooltips.birthDate && !hover.birthDate}" id="birthDateTooltip">Ngày sinh không hợp lệ hoặc phải ít nhất 6 tuổi</span>
                    </div>
                </div>
                <div class="mb-3 position-relative">
                    <label>Giới Tính:</label>
                    <select name="gender" ng-model="user.gender" required ng-change="validateField('gender')" class="form-control" id="gender" ng-class="getClass('gender')">
                        <option value="" disabled selected>Chọn giới tính</option>
                        <option value="Nam">Nam</option>
                        <option value="Nữ">Nữ</option>
                    </select>
                    <div class="d-inline-block tooltip-block" style="left:62px;">
                        <i class="fa-solid fa-circle-exclamation" ng-mouseenter="hover.gender = true" ng-mouseleave="hover.gender = false"></i>
                        <span class="custom-tooltip" ng-class="{'tooltip-hidden': !tooltips.gender && !hover.gender}" id="genderTooltip">Giới tính là bắt buộc</span>
                    </div>
                </div>
                <div class="mb-3 position-relative">
                    <label>Địa chỉ:</label>
                    <select name="address" ng-model="user.address" required ng-change="validateField('address')" class="form-control" id="address" ng-class="getClass('address')">
                        <option value="" disabled selected>Chọn tỉnh thành</option>
                        <option value="Hà Nội">Hà Nội</option>
                        <option value="TP.Hồ Chí Minh">TP.Hồ Chí Minh</option>
                        <option value="Cần Thơ">Cần Thơ</option>
                        <option value="Cà Mau">Cà Mau</option>
                        <option value="Huế">Huế</option>
                        <option value="Đà Nẵng">Đà Nẵng</option>
                    </select>
                    <div class="d-inline-block tooltip-block" style="left:48px;">
                        <i class="fa-solid fa-circle-exclamation" ng-mouseenter="hover.address = true" ng-mouseleave="hover.address = false"></i>
                        <span class="custom-tooltip" ng-class="{'tooltip-hidden': !tooltips.address && !hover.address}" id="addressTooltip">Địa chỉ là bắt buộc</span>
                    </div>
                </div>
                <div class="mb-3 position-relative">
                    <label>Username:</label>
                    <input type="text" name="username" placeholder="Nhập tên tài khoản" ng-model="user.username" required ng-keyup="validateField('username')" ng-pattern="/^[a-z0-9]{6,16}$/" class="form-control" id="username" ng-class="{'border border-danger': tooltips.username, 'border border-success': !tooltips.username && registrationForm.username.$dirty}" />
                    <div class="d-inline-block tooltip-block">
                        <i class="fa-solid fa-circle-exclamation" ng-mouseenter="hover.username = true" ng-mouseleave="hover.username = false"></i>
                        <span class="custom-tooltip" ng-class="{'tooltip-hidden': !tooltips.username && !hover.username}" id="usernameTooltip">Tên đăng nhập là bắt buộc, không được chứa khoảng trắng và dài từ 6 đến 16 kí tự</span>
                    </div>
                </div>
                <div class="mb-3 position-relative">
                    <label>Password:</label>
                    <div class="input-group">
                        <input type="password" name="password" placeholder="Nhập mật khẩu" ng-model="user.password" required ng-pattern="/^(?=.*[a-z])(?=.*\d)(?=.*[^a-zA-Z0-9\s])[^\s]{6,16}$/" ng-keyup="validateField('password')" class="form-control border-end-0" id="password" ng-class="{'border border-danger': tooltips.password, 'border border-success': !tooltips.password && registrationForm.password.$dirty}" />
                        <span class="input-group-text border-1 border-start-0 bg-transparent"
                              id="inputGroupAppend" toggle-visibility="#password" style="cursor:pointer;"
                              ng-class="{'border border-danger': tooltips.password, 'border border-success': !tooltips.password && registrationForm.password.$dirty}">
                            <i class="fa-regular fa-eye"></i>
                        </span>
                    </div>
                    <div class="d-inline-block tooltip-block">
                        <i class="fa-solid fa-circle-exclamation" ng-mouseenter="hover.password = true" ng-mouseleave="hover.password = false"></i>
                        <span class="custom-tooltip" ng-class="{'tooltip-hidden': !tooltips.password && !hover.password}" id="passwordTooltip">Mật khẩu phải chứa ít nhất 1 ký tự thường, 1 ký tự số và 1 ký tự đặc biệt, không được chứa khoảng trắng và dài từ 6 đến 16 kí tự</span>
                    </div>
                </div>
                <div class="mb-3 position-relative">
                    <label>Nhập lại Password:</label>
                    <div class="input-group">
                        <input type="password" name="repassword" placeholder="Nhập lại mật khẩu" ng-model="user.repassword" required compare-to="user.password" ng-keyup="validateField('repassword')" class="form-control border-end-0" id="repassword" ng-class="{'border border-danger': tooltips.repassword, 'border border-success': !tooltips.repassword && registrationForm.repassword.$dirty}" />
                        <span class="input-group-text border-1 border-start-0 bg-transparent "
                              id="inputGroupAppend" toggle-visibility="#repassword" style="cursor:pointer;"
                              ng-class="{'border border-danger': tooltips.repassword, 'border border-success': !tooltips.repassword && registrationForm.repassword.$dirty}" >
                            <i class="fa-regular fa-eye"></i>
                        </span>
                    </div>
                    <div class="d-inline-block tooltip-block" style="left:129px;">
                        <i class="fa-solid fa-circle-exclamation" ng-mouseenter="hover.repassword = true" ng-mouseleave="hover.repassword = false"></i>
                        <span class="custom-tooltip" ng-class="{'tooltip-hidden': !tooltips.repassword && !hover.repassword}" id="repasswordTooltip">Mật khẩu xác nhận không khớp</span>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" ng-click="registerUser()">Đăng Ký</button>
            </form>        
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        var app = angular.module('registrationApp', []);


        //Controller cho Form Đăng Ký
        app.controller('registrationController', function ($scope, $http, $window) {
            $scope.user = {}; //Tạo một đối tượng người dùng
            $scope.tooltips = { // Tạo một đối tượng để chứa các tooltip trên form 
                //Cho các tooltip đó đều false để tránh hiển thị lên khi người dùng chưa thực hiện hành động gì
                fullName: false,
                phoneNumber: false,
                birthDate: false,
                gender: false,
                address: false,
                username: false,
                password: false,
                repassword: false
            };

            //Tạo một hàm thực hiển việc đăng ký
            $scope.registerUser = function () {
                if ($scope.registrationForm.$valid) { // Kiểm tra tính hợp lệ của form đăng ký
                    $http.post('/User/CreateUser', $scope.user).then(function (response) { // Nếu hợp lệ thì thực hiển các hành động dưới đây 
                        alert('Thêm người dùng thành công!'); // Thông báo thêm người dùng thành công
                        $scope.user = {}; // Clear các thông tin người dùng nhập 
                        $scope.registrationForm.$setPristine(); // Đặt trạng thái form về "pristine" (người dùng chưa tương tác) 
                        $scope.registrationForm.$setUntouched(); // Đặt lại trạng thái hiển thị của các điều khiển biểu mẫu làm cho chúng xuất hiện như thể người dùng chưa từng tương tác với chúng.
                        $scope.tooltips = { // Set các tooltips về lại trạng thái không xuất hiện
                            fullName: false,
                            phoneNumber: false,
                            birthDate: false,
                            gender: false,
                            address: false,
                            username: false,
                            password: false,
                            repassword: false
                        };
                        $window.location.href = '/user/index'; // Chuyển trang localhost:{port}/user/index
                    }, function (error) { // Nếu hàm thực hiện xảy ra lỗi thì thông báo ra lỗi
                        $scope.errorMessage = 'Xảy ra lỗi với dữ liệu: ' + error.data;
                        alert($scope.errorMessage);
                    });
                } else { // Nếu người dùng nhập thiếu hay nhập sai mà bấm thực hiện đăng ký thì sẽ thông báo hãy điền dữ liệu
                    $scope.errorMessage = 'Hãy điền dữ liệu đầy đủ và đúng yêu cầu.';
                    alert($scope.errorMessage);
                }
            };

            $scope.validateField = function (fieldName) { // Hàm kiểm tra tính hợp lệ của các trường input theo fieldname
                var field = $scope.registrationForm[fieldName]; //Lấy fieldname được truyền khi sử dụng hàm trên input
                if (fieldName === 'birthDate') {
                    // Kiểm tra valid của ngày sinh
                    $scope.tooltips.birthDate = !validateBirthDate($scope.user.birthDate);
                } else if (fieldName === 'gender' || fieldName === 'address') {
                    //// Kiểm tra nếu select gender hoặc address có value là rỗng
                    $scope.tooltips[fieldName] = $scope.user[fieldName] === '';
                } else if (field) {
                    // Kiểm tra valid của các input khác
                    $scope.tooltips[fieldName] = field.$invalid && field.$dirty;
                } else {
                    console.error('Field not found:', fieldName);
                }
            };

            $scope.getClass = function (fieldName) {
                // Thực hiện đổ border lên các trường select như gender và address
                var field = $scope.registrationForm[fieldName];
                if (fieldName === 'gender' || fieldName === 'address') {
                    if ($scope.user[fieldName] === undefined) {
                        return '';
                    }
                    // Nếu input rỗng thì trả về 2 class 'border border-danger' ngược lại trả về 2 class 'border border-success'
                    return $scope.user[fieldName] === '' ? 'border border-danger' : 'border border-success';
                }
                // Nếu input không hợp lệ thì trả về 2 class 'border border-danger' ngược lại trả về 2 class 'border border-success'
                return field && field.$dirty ? (field.$invalid ? 'border border-danger' : 'border border-success') : '';
            };

            function validateBirthDate(inputDate) { // Hàm thực hiện việc kiểm tra giới hạn độ tuổi nhỏ nhất của trường birthdate
                const currentDate = new Date();
                const userDate = new Date(inputDate);

                if (isNaN(userDate) || userDate > currentDate) { // Kiểm tra nếu ngày sinh người dùng nhập vào là ngày tương lai thì trả về false
                    return false;
                }
                const minAgeDate = new Date();
                minAgeDate.setFullYear(minAgeDate.getFullYear() - 6);

                if (userDate > minAgeDate) { // Kiểm tra nếu ngày sinh người dùng có tuổi thấp hơn 6 thì trả về false 
                    return false;
                }
                return true;
            }
        });

        //Directive dành cho việc so sánh mật khẩu và xác nhận mật khẩu
        app.directive('compareTo', function () {
            return {
                require: "ngModel", // Yêu cầu một model được gắn trên input
                scope: {
                    otherModelValue: "=compareTo" // Biến của Directive
                },
                link: function (scope, element, attributes, ngModel) { 
                    // Hàm thực hiện việc so sánh này so sánh modelValue (giá trị hiện tại của input mà directive được áp dụng) với scope.otherModelValue.
                    ngModel.$validators.compareTo = function (modelValue) {
                        return modelValue == scope.otherModelValue;  // //Nếu bằng nhau trả về true, nếu không, trả về false.
                       
                    };

                    scope.$watch("otherModelValue", function () { //Theo dõi sự thay đổi của otherModelValue
                        ngModel.$validate(); //Mỗi lần otherModelValue có sự thay đổi thì sẽ gọi ngModel.$validate() để kiểm tra tính hợp lệ của giá trị
                    });
                }
            };
        });

        //Directive cho việc hiển thị password
        app.directive('toggleVisibility', function () {
            return {
                restrict: 'A', // Sử dụng directive này như một attribute
                link: function (scope, element, attrs) {
                    const visibilityIcon = element.find('i'); // tìm kiếm thẻ <i> chứa icon
                    const passwordField = angular.element(document.querySelector(attrs.toggleVisibility)); //Tìm kiểm những input nào sử dụng attribute Directive này

                    element.on('click', function () { // Thực hiện hành đồng khi người dùng khi người dùng click vào
                        //Kiểm tra nếu ô sử sử dụng directive có input là kiểu text thì chuyển thành password và chuyển đổi icon sao cho phù hợp
                        if (passwordField.attr('type') === 'password') {
                            passwordField.attr('type', 'text');
                            visibilityIcon.removeClass('fa-eye');
                            visibilityIcon.addClass('fa-eye-slash');
                        } else {
                            passwordField.attr('type', 'password');
                            visibilityIcon.removeClass('fa-eye-slash');
                            visibilityIcon.addClass('fa-eye');
                        }
                    });
                }
            };
        });
    </script>
}
